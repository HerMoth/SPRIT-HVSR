

<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hvsr.sprit &#8212; SPRIT 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SPRIT 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hvsr.sprit</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hvsr.sprit</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains all the functions needed to run the HVSR analysis</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">obspy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="c1">#Main variables</span>
<span class="n">greek_chars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u03C3</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilon&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u03B5</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;teta&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u03B8</span><span class="s1">&#39;</span><span class="p">}</span>
<span class="n">channel_order</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">separator_character</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">max_rank</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">plotRows</span> <span class="o">=</span> <span class="mi">4</span>


<div class="viewcode-block" id="check_mark"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.check_mark">[docs]</a><span class="k">def</span> <span class="nf">check_mark</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The default Windows terminal is not able to display the check mark character correctly.</span>
<span class="sd">       This function returns another displayable character if platform is Windows&quot;&quot;&quot;</span>
    <span class="c1">#This does not seem to be a problem for my system at least, so am not using it currently</span>
    <span class="n">check</span> <span class="o">=</span> <span class="n">get_char</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u2714</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1">#if sys.platform == &#39;win32&#39;:</span>
    <span class="c1">#    check = get_char(u&#39;\u039E&#39;)</span>
    <span class="k">return</span> <span class="n">check</span></div>

<div class="viewcode-block" id="get_char"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.get_char">[docs]</a><span class="k">def</span> <span class="nf">get_char</span><span class="p">(</span><span class="n">in_char</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Outputs character with proper encoding/decoding&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">in_char</span> <span class="ow">in</span> <span class="n">greek_chars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">out_char</span> <span class="o">=</span> <span class="n">greek_chars</span><span class="p">[</span><span class="n">in_char</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_char</span> <span class="o">=</span> <span class="n">in_char</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="time_it"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.time_it">[docs]</a><span class="k">def</span> <span class="nf">time_it</span><span class="p">(</span><span class="n">_t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes elapsed time since the last call.&quot;&quot;&quot;</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">_t</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span>
    <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="c1">#print(f&#39;[TIME] {dt:0.1f} s&#39;, flush=True)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="k">return</span> <span class="n">t</span></div>

<span class="c1">##msgLib functions</span>
<span class="c1">#Post message</span>
<div class="viewcode-block" id="message"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.message">[docs]</a><span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="n">post_message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prints a run message&quot;&quot;&quot;</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">12</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="n">post_message</span><span class="p">,</span> <span class="n">bar</span><span class="p">))</span></div>

<span class="c1">#Post error</span>
<div class="viewcode-block" id="error"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.error">[docs]</a><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">err_message</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prints an error message&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ERR] </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err_message</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">code</span></div>

<span class="c1">#Post warning</span>
<div class="viewcode-block" id="warning"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.warning">[docs]</a><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">warn_message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a warning message&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[WARN] from </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">warn_message</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="c1">#Post info message</span>
<div class="viewcode-block" id="info"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.info">[docs]</a><span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="n">info_message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prints an informative message&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">info_message</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span></div>

<span class="c1">#Converts filepaths to pathlib paths, if not already</span>
<div class="viewcode-block" id="checkifpath"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.checkifpath">[docs]</a><span class="k">def</span> <span class="nf">checkifpath</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Support function to check if a filepath is a pathlib.Path object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str or pathlib.Path, or anything</span>
<span class="sd">        Filepath to check. If not a valid filepath, will not convert and raises error</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># checks if the variable is any instance of pathlib</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="c1">#print(&#39;Converted string to pathlib path&#39;) #Assume a string was input rather than pathlib object</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Input cannot be converted to pathlib path&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filepath</span></div>

<span class="c1">#Formats time into desired output</span>
<span class="k">def</span> <span class="nf">__formatTime</span><span class="p">(</span><span class="n">inputDT</span><span class="p">,</span> <span class="n">tzone</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function to format time, used in other functions</span>

<span class="sd">    Formats input time to datetime objects in utc</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inputDT : str or datetime obj </span>
<span class="sd">        Input datetime. Can include date and time, just date (time inferred to be 00:00:00.00) or just time (if so, date is set as today)</span>
<span class="sd">    tzone   : str=&#39;utc&#39; or int {&#39;utc&#39;, &#39;local&#39;} </span>
<span class="sd">        Timezone of data entry. </span>
<span class="sd">            If string and not utc, assumed to be timezone of computer running the process.</span>
<span class="sd">            If int, assumed to be offset from UTC (e.g., CST in the United States is -6; CDT in the United States is -5)</span>
<span class="sd">    dst     : bool=True </span>
<span class="sd">        If any string aside from &#39;utc&#39; is specified for tzone, this will adjust according to daylight savings time. </span>
<span class="sd">            If tzone is int, no adjustment is made</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outputTimeObj   : datetime object in UTC</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputDT</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1">#tzone = &#39;America/Chicago&#39;</span>
        <span class="c1">#Format string to datetime obj</span>
        <span class="n">div</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">timeDiv</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">inputDT</span><span class="p">:</span>
            <span class="n">div</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
            <span class="n">hasDate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">inputDT</span><span class="p">:</span>
            <span class="n">div</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">hasDate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hasDate</span><span class="o">=</span> <span class="kc">False</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">day</span>

        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">inputDT</span><span class="p">:</span>
            <span class="n">hasTime</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">inputDT</span><span class="p">:</span>
                <span class="n">timeDiv</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeDiv</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hasTime</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">hasDate</span><span class="p">:</span>
            <span class="c1">#If first number is 4-dig year (assumes yyyy-dd-mm is not possible)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">month</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">day</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1">#If last number is 4-dig year            </span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="c1">#..and first number is day</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">12</span><span class="p">:</span>
                    <span class="c1">#dateStr = &#39;%d&#39;+div+&#39;%m&#39;+div+&#39;%Y&#39;   </span>
                    <span class="n">year</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#...and first number is month (like American style)                             </span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>     
            
            <span class="c1">#Another way to catch if first number is (2-digit) year</span>
            <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">31</span><span class="p">:</span>
                <span class="c1">#dateStr = &#39;%y&#39;+div+&#39;%m&#39;+div+&#39;%d&#39;</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#Assumes anything less than current year is from this century</span>
                <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;20&#39;</span><span class="o">+</span><span class="n">year</span>
                <span class="k">else</span><span class="p">:</span><span class="c1">#...and anything more than current year is from last century</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;19&#39;</span><span class="o">+</span><span class="n">year</span>
                <span class="c1">#assumes day will always come last in this instance, as above</span>
                <span class="n">month</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">day</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#If last digit is (2 digit) year           </span>
            <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">31</span><span class="p">:</span>
                <span class="c1">#...and first digit is day</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">12</span><span class="p">:</span>
                    <span class="c1">#dateStr = &#39;%d&#39;+div+&#39;%m&#39;+div+&#39;%y&#39;       </span>
                    <span class="n">year</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
                        <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;20&#39;</span><span class="o">+</span><span class="n">year</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;19&#39;</span><span class="o">+</span><span class="n">year</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>                           
                <span class="k">else</span><span class="p">:</span> <span class="c1">#...and second digit is day</span>
                    <span class="c1">#dateStr = &#39;%m&#39;+div+&#39;%d&#39;+div+&#39;%y&#39;</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
                        <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;20&#39;</span><span class="o">+</span><span class="n">year</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;19&#39;</span><span class="o">+</span><span class="n">year</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>                  

        <span class="n">hour</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">minute</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">sec</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">microS</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">hasTime</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hasDate</span><span class="p">:</span>
                <span class="n">timeStr</span> <span class="o">=</span> <span class="n">inputDT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timeDiv</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeStr</span> <span class="o">=</span> <span class="n">inputDT</span>
            
            <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">timeStr</span><span class="p">:</span>
                <span class="n">timeStr</span><span class="o">=</span><span class="n">timeStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">timeStr</span><span class="p">:</span>
                <span class="n">timeStr</span><span class="o">=</span><span class="n">timeStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">timeStrList</span> <span class="o">=</span> <span class="n">timeStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeStrList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">timeStrList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStrList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeStrList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">23</span><span class="p">:</span>
                <span class="n">timeStrList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStrList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">timeStrList</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">microS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeStrList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">timeStrList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStrList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeStrList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">minute</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">timeStrList</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeStrList</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


        <span class="n">outputTimeObj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="n">month</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="n">day</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">),</span>
                                <span class="n">hour</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">hour</span><span class="p">),</span> <span class="n">minute</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">minute</span><span class="p">),</span> <span class="n">second</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="p">),</span> <span class="n">microsecond</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">microS</span><span class="p">))</span>

    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputDT</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputDT</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
        <span class="n">outputTimeObj</span> <span class="o">=</span> <span class="n">inputDT</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tzone</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span> <span class="c1">#Plus/minus needs to be correct there</span>
        <span class="n">outputTimeObj</span> <span class="o">=</span> <span class="n">outputTimeObj</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">tzone</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">tzone</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tzone</span> <span class="o">!=</span> <span class="s1">&#39;utc&#39;</span><span class="p">:</span>
            <span class="n">utc_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="n">localTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">utcOffset</span> <span class="o">=</span> <span class="n">utc_time</span><span class="o">-</span><span class="n">localTime</span>
            <span class="n">outputTimeObj</span><span class="o">=</span><span class="n">outputTimeObj</span><span class="o">+</span><span class="n">utcOffset</span>
            <span class="n">utcOffset</span> <span class="o">=</span> <span class="n">utc_time</span><span class="o">-</span><span class="n">localTime</span>
            <span class="n">outputTimeObj</span> <span class="o">=</span> <span class="n">outputTimeObj</span><span class="o">+</span><span class="n">utcOffset</span>
            <span class="k">if</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">outputTimeObj</span> <span class="o">=</span> <span class="n">outputTimeObj</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outputTimeObj</span>

<span class="c1">#Sort Channels later</span>
<span class="k">def</span> <span class="nf">__sortchannels</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">,</span> <span class="s1">&#39;EHN&#39;</span><span class="p">,</span> <span class="s1">&#39;EHE&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;Private function to sort channels. Not currently used</span>
<span class="sd">    </span>
<span class="sd">    Sort channels. Z/vertical should be first, horizontal order doesn&#39;t matter, but N 2nd and E 3rd is default</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        channels    : list = [&#39;EHZ&#39;, &#39;EHN&#39;, &#39;EHE&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">channel_order</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

    <span class="n">sorted_channel_list</span> <span class="o">=</span> <span class="n">channels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">sorted_channel_list</span><span class="p">[</span><span class="n">channel_order</span><span class="p">[</span><span class="n">channel</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">channel</span>
    <span class="k">return</span> <span class="n">sorted_channel_list</span>

<span class="c1">#Define input parameters</span>
<div class="viewcode-block" id="input_param"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.input_param">[docs]</a><span class="k">def</span> <span class="nf">input_param</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="s1">&#39;AM&#39;</span><span class="p">,</span> 
                        <span class="n">station</span><span class="o">=</span><span class="s1">&#39;RAC84&#39;</span><span class="p">,</span> 
                        <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;00&#39;</span><span class="p">,</span> 
                        <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">,</span> <span class="s1">&#39;EHN&#39;</span><span class="p">,</span> <span class="s1">&#39;EHE&#39;</span><span class="p">],</span>
                        <span class="n">acq_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()),</span>
                        <span class="n">starttime</span> <span class="o">=</span> <span class="s1">&#39;00:00:00.00&#39;</span><span class="p">,</span>
                        <span class="n">endtime</span> <span class="o">=</span> <span class="s1">&#39;23:59:99.99&#39;</span><span class="p">,</span>
                        <span class="n">tzone</span> <span class="o">=</span> <span class="s1">&#39;America/Chicago&#39;</span><span class="p">,</span> <span class="c1">#or &#39;UTC&#39;</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">88.2290526</span><span class="p">,</span>
                        <span class="n">lat</span> <span class="o">=</span>  <span class="mf">40.1012122</span><span class="p">,</span>
                        <span class="n">elevation</span> <span class="o">=</span> <span class="mi">755</span><span class="p">,</span>
                        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">instrument</span> <span class="o">=</span> <span class="s1">&#39;Raspberry Shake&#39;</span><span class="p">,</span>
                        <span class="n">dataPath</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">metaPath</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">site</span> <span class="o">=</span> <span class="s1">&#39;HVSR SITE&#39;</span><span class="p">,</span>
                        <span class="n">hvsr_band</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span> 
                        <span class="p">):</span>

    <span class="c1">#Make Sure metapath is all good</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">metaPath</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">metaPath</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metaPath</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No metadata file specified!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Specified metadata file cannot be read!&#39;</span><span class="p">)</span>
        <span class="n">repoDir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">())</span>
        <span class="n">repoDir</span> <span class="o">=</span> <span class="n">repoDir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">metaPath</span><span class="o">=</span><span class="n">repoDir</span><span class="o">+</span><span class="s1">&#39;/resources/raspshake_metadata.inv&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using default metadata file for Raspberry Shake v.7 contained in repository at</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">metaPath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metaPath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metaPath</span><span class="p">)</span>

    <span class="c1">#Reformat time</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">acq_date</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
        <span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">acq_date</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">year</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">acq_date</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">starttime</span><span class="p">:</span>
            <span class="n">date</span><span class="o">=</span><span class="n">starttime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">starttime</span> <span class="o">=</span> <span class="n">starttime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">starttime</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">starttime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span>
    
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">date</span><span class="o">+</span><span class="s2">&quot;T&quot;</span><span class="o">+</span><span class="n">starttime</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">__formatTime</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">tzone</span><span class="o">=</span><span class="n">tzone</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">endtime</span><span class="p">:</span>
            <span class="n">date</span><span class="o">=</span><span class="n">endtime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">endtime</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">endtime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span>

    <span class="n">endtime</span> <span class="o">=</span> <span class="n">date</span><span class="o">+</span><span class="s2">&quot;T&quot;</span><span class="o">+</span><span class="n">endtime</span>
    <span class="n">endtime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">__formatTime</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">tzone</span><span class="o">=</span><span class="n">tzone</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">))</span>

    <span class="n">acq_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">month</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">day</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">raspShakeInstNameList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raspberry shake&#39;</span><span class="p">,</span> <span class="s1">&#39;shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspberry&#39;</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;rs3d&#39;</span><span class="p">,</span> <span class="s1">&#39;rasp. shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspshake&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">instrument</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span>  <span class="n">raspShakeInstNameList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metaPath</span> <span class="o">==</span> <span class="sa">r</span><span class="s1">&#39;resources/raspshake_metadata.inv&#39;</span><span class="p">:</span>
            <span class="n">metadir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">metadir</span> <span class="o">=</span> <span class="n">metadir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">metaPath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">metaPath</span>

    <span class="n">inputParamDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;net&#39;</span><span class="p">:</span><span class="n">network</span><span class="p">,</span><span class="s1">&#39;sta&#39;</span><span class="p">:</span><span class="n">station</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span><span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;cha&#39;</span><span class="p">:</span><span class="n">channels</span><span class="p">,</span> <span class="s1">&#39;instrument&#39;</span><span class="p">:</span><span class="n">instrument</span><span class="p">,</span>
                    <span class="s1">&#39;acq_date&#39;</span><span class="p">:</span><span class="n">acq_date</span><span class="p">,</span><span class="s1">&#39;starttime&#39;</span><span class="p">:</span><span class="n">starttime</span><span class="p">,</span><span class="s1">&#39;endtime&#39;</span><span class="p">:</span><span class="n">endtime</span><span class="p">,</span> <span class="s1">&#39;timezone&#39;</span><span class="p">:</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span><span class="n">lon</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">:</span><span class="n">lat</span><span class="p">,</span><span class="s1">&#39;elevation&#39;</span><span class="p">:</span><span class="n">elevation</span><span class="p">,</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span><span class="n">depth</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">:</span><span class="n">site</span><span class="p">,</span>
                    <span class="s1">&#39;dataPath&#39;</span><span class="p">:</span><span class="n">dataPath</span><span class="p">,</span> <span class="s1">&#39;metaPath&#39;</span><span class="p">:</span><span class="n">metaPath</span><span class="p">,</span> <span class="s1">&#39;hvsr_band&#39;</span><span class="p">:</span><span class="n">hvsr_band</span>
                    <span class="p">}</span>

    <span class="k">return</span> <span class="n">inputParamDict</span></div>

<span class="c1">#Read in metadata .inv file, specifically for RaspShake</span>
<div class="viewcode-block" id="update_shake_metadata"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.update_shake_metadata">[docs]</a><span class="k">def</span> <span class="nf">update_shake_metadata</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">write_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads static metadata file provided for Rasp Shake and updates with input parameters</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath    : str or pathlib.Path object</span>
<span class="sd">            Filepath to Raspberry Shake metadata file </span>
<span class="sd">        params      : dict</span>
<span class="sd">            Dictionary containing necessary keys/values for updating</span>
<span class="sd">                Necessary keys: &#39;net&#39;, &#39;sta&#39;, </span>
<span class="sd">                Optional keys: &#39;longitude&#39;, &#39;latitude&#39;, &#39;elevation&#39;, &#39;depth&#39;</span>
<span class="sd">        write_path   : str, optional</span>
<span class="sd">            If specified, filepath to write to updated inventory file to</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : dict</span>
<span class="sd">            Updated params dict with new key:value pair with updated updated obspy.inventory object (key=&quot;inv&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">network</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span>
    <span class="n">station</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span>
    <span class="n">optKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">optKeys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">])</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span>
    
    <span class="n">startdate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2023</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span> <span class="c1">#First day with working code</span>
    <span class="n">enddate</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="n">checkifpath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

    <span class="n">prefix</span><span class="o">=</span> <span class="s2">&quot;{http://www.fdsn.org/xml/station/1}&quot;</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Channel&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;startDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startdate</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;endDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enddate</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Station&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;startDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startdate</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;endDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enddate</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Network&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span>
        
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Latitude&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">lat</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Longitude&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">lon</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Created&#39;</span><span class="p">):</span>
        <span class="n">nowTime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">nowTime</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Elevation&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="o">=</span> <span class="n">elevation</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Depth&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="o">=</span><span class="n">depth</span>

    <span class="c1">#Set up (and) export</span>
    <span class="c1">#filetag = &#39;_&#39;+str(datetime.datetime.today().date())</span>
    <span class="c1">#outfile = str(parentPath)+&#39;\\&#39;+filename+filetag+&#39;.inv&#39;</span>

    <span class="k">if</span> <span class="n">write_path</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_path</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">write_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#Create temporary file for reading into obspy</span>
        <span class="n">tpf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">stringRoot</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">)</span>
        <span class="n">tpf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stringRoot</span><span class="p">)</span>

        <span class="n">inv</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
        <span class="n">tpf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span>
    <span class="k">return</span> <span class="n">params</span></div>

<span class="c1">#Code to help setup environment in Google Colab</span>
<div class="viewcode-block" id="setup_colab"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.setup_colab">[docs]</a><span class="k">def</span> <span class="nf">setup_colab</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">pathlib</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">scipy</span>

    <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">files</span>
    <span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
    <span class="c1">#%matplotlib #Run this line if you want interactive plots</span>

    <span class="kn">import</span> <span class="nn">obspy</span>
    <span class="c1">#Make directories</span>
    <span class="n">dataDir</span> <span class="o">=</span> <span class="s1">&#39;/content/Data/&#39;</span>
    <span class="n">outputDir</span> <span class="o">=</span> <span class="s1">&#39;/content/Output&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dataDir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dataDir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputDir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outputDir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Colab setup complete&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dataDir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Upload data files: (files will be placed in &#39;</span><span class="o">+</span><span class="n">dataDir</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span> <span class="c1">#Upload the 3 data files to be used</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">repo_dir</span><span class="p">)</span>
    <span class="k">return</span></div>

<span class="c1">#Gets the metadata for Raspberry Shake, specifically for 3D v.7</span>
<div class="viewcode-block" id="get_metadata"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.get_metadata">[docs]</a><span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">write_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get metadata and calculate or get paz parameter needed for PPSD</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : dict</span>
<span class="sd">        Dictionary containing all the input and other parameters needed for processing</span>
<span class="sd">            Ouput from input_params() function</span>
<span class="sd">    write_path : str</span>
<span class="sd">        String with output filepath of where to write updated inventory or metadata file</span>
<span class="sd">            If not specified, does not write file </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    params : dict</span>
<span class="sd">        Modified input dictionary with additional key:value pair containing paz dictionary (key = &quot;paz&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invPath</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;metaPath&#39;</span><span class="p">]</span>
    <span class="n">raspShakeInstNameList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raspberry shake&#39;</span><span class="p">,</span> <span class="s1">&#39;shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspberry&#39;</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;rs3d&#39;</span><span class="p">,</span> <span class="s1">&#39;rasp. shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspshake&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span>  <span class="n">raspShakeInstNameList</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">update_shake_metadata</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">invPath</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">write_path</span><span class="o">=</span><span class="n">write_path</span><span class="p">)</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">checkifpath</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

    <span class="n">station</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;cha&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">):</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">checkifpath</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#Create temporary file from inventory object</span>
        <span class="n">tpf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">inv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">)</span>

        <span class="c1">#Read data into xmlTree</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="c1">#Close and remove temporary file</span>
        <span class="n">tpf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1">#if write_path != &#39;&#39;:</span>
    <span class="c1">#    inv.write(write_path, format=&#39;STATIONXML&#39;)</span>

    <span class="n">c</span><span class="o">=</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pzList</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">))]</span>
    <span class="n">s</span><span class="o">=</span><span class="n">pzList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">prefix</span><span class="o">=</span> <span class="s2">&quot;{http://www.fdsn.org/xml/station/1}&quot;</span>

    <span class="n">sensitivityPath</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;InstrumentSensitivity/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Value&quot;</span>
    <span class="n">gainPath</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;StageGain/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Value&quot;</span>

    <span class="c1">#paz = []</span>
    <span class="n">paz</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">channelPaz</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#channelPaz[&#39;channel&#39;] = c</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">sensitivityPath</span><span class="p">):</span>
            <span class="n">channelPaz</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">gainPath</span><span class="p">):</span>
            <span class="n">channelPaz</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        
        <span class="n">poleList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">zeroList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pzList</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">polePathReal</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;PolesZeros/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Pole[@number=&#39;&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Real&quot;</span>
                <span class="n">polePathImag</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;PolesZeros/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Pole[@number=&#39;&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Imaginary&quot;</span>
                <span class="k">for</span> <span class="n">poleItem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">polePathReal</span><span class="p">):</span>
                    <span class="n">poleReal</span> <span class="o">=</span> <span class="n">poleItem</span><span class="o">.</span><span class="n">text</span>
                <span class="k">for</span> <span class="n">poleItem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">polePathImag</span><span class="p">):</span>
                    <span class="n">pole</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">poleReal</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">poleItem</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
                    <span class="n">poleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pole</span><span class="p">)</span>
                    <span class="n">channelPaz</span><span class="p">[</span><span class="s1">&#39;poles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poleList</span>
                    <span class="c1">#channelPaz[&#39;poles&#39;] = list(set(poleList))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zeroPathReal</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;PolesZeros/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Zero[@number=&#39;&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Real&quot;</span>
                <span class="n">zeroPathImag</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;PolesZeros/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Zero[@number=&#39;&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Imaginary&quot;</span>
                <span class="k">for</span> <span class="n">zeroItem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">zeroPathReal</span><span class="p">):</span>
                    <span class="n">zeroReal</span> <span class="o">=</span> <span class="n">zeroItem</span><span class="o">.</span><span class="n">text</span>
                
                <span class="k">for</span> <span class="n">zeroItem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">zeroPathImag</span><span class="p">):</span>
                    <span class="n">zero</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">zeroReal</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">zeroItem</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
                    <span class="c1">#zero = zeroReal + &quot;+&quot; + zeroItem.text+&#39;j&#39;</span>
                    <span class="n">zeroList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
                    <span class="c1">#channelPaz[&#39;zeros&#39;] = list(set(zeroList))</span>
                    <span class="n">channelPaz</span><span class="p">[</span><span class="s1">&#39;zeros&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeroList</span>

        <span class="n">paz</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">channelPaz</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paz</span>
    <span class="k">return</span> <span class="n">params</span></div>

<span class="c1">#Reads in traces to obspy stream</span>
<div class="viewcode-block" id="fetch_data"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.fetch_data">[docs]</a><span class="k">def</span> <span class="nf">fetch_data</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="n">trim_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">export_format</span><span class="o">=</span><span class="s1">&#39;mseed&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch ambient seismic data from a source to read into obspy stream</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params  : dict</span>
<span class="sd">            Dictionary containing all the necessary params to get data.</span>
<span class="sd">                Parameters defined using input_params() function.</span>
<span class="sd">        inv     : obspy inventory object </span>
<span class="sd">            Obspy inventory object containing metadata for instrument that collected data to be fetched</span>
<span class="sd">        source  : str=&#39;raw&#39; {&#39;raw&#39;, &#39;direct&#39;}</span>
<span class="sd">            String indicating where/how data file was created. For example, if raw data, will need to find correct channels.</span>
<span class="sd">                &#39;raw&#39; finds raspberry shake data, either in folder or subfolders; &#39;direct&#39; reads filepath directly</span>
<span class="sd">        trim_dir : bool=False or str or pathlib obj</span>
<span class="sd">            If false, data is not trimmed in this function.</span>
<span class="sd">            Otherwise, this is the directory to save the trimmed and exported data</span>
<span class="sd">        export_format: str=&#39;mseed&#39;</span>
<span class="sd">            If trim_dir is not False, this is the format in which to save the data</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataIN : obspy stream</span>
<span class="sd">            Obspy data stream with 3 traces: Z (vertical), N (North-south), and E (East-west)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;dataPath&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">],</span> 
    <span class="n">date</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">checkifpath</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
    <span class="n">inst</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>

    <span class="c1">#Need to put dates and times in right formats first</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">366</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;First item in date tuple must be day of year (0-366)&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Second item in date tuple should be year, but given item is in the future&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">date</span><span class="p">:</span>
            <span class="n">dateSplit</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>            
        <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">date</span><span class="p">:</span>
            <span class="n">dateSplit</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dateSplit</span> <span class="o">=</span> <span class="n">date</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;=</span><span class="mi">12</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preferred date format is &#39;yyyy-mm-dd&#39; or &#39;yyyy/mm/dd&#39;. Will attempt to parse date.&quot;</span><span class="p">)</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preferred date format is &#39;yyyy-mm-dd&#39; or &#39;yyyy/mm/dd&#39;. Cannot parse date.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1">#FOR NOW, need to update</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Did not recognize date, using year </span><span class="si">{}</span><span class="s2"> and day </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Day of Year:&#39;</span><span class="p">,</span> <span class="n">doy</span><span class="p">)</span>

    <span class="c1">#Select which instrument we are reading from (requires different processes for each instrument)</span>
    <span class="n">raspShakeInstNameList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raspberry shake&#39;</span><span class="p">,</span> <span class="s1">&#39;shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspberry&#39;</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;rs3d&#39;</span><span class="p">,</span> <span class="s1">&#39;rasp. shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspshake&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">raspShakeInstNameList</span><span class="p">:</span>
            <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">__read_RS_data</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]),</span> <span class="n">endttime</span><span class="o">=</span><span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]),</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rawDataIN</span><span class="o">.</span><span class="n">attach_response</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">rawDataIN</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]:</span><span class="c1">#[12:15]:</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="n">rawDataIN</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="n">rawDataIN</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s1">&#39;channel&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#z, n, e order</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">trim_dir</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="n">trim_data</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">dataIN</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">export_dir</span><span class="o">=</span><span class="n">trim_dir</span><span class="p">,</span> <span class="n">export_format</span><span class="o">=</span><span class="n">export_format</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataIN</span></div>

<span class="c1">#Read data from raspberry shake</span>
<span class="k">def</span> <span class="nf">__read_RS_data</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;Private function used by fetch_data() to read in Raspberry Shake data&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">obspy.core</span> <span class="kn">import</span> <span class="n">UTCDateTime</span>
    <span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">folderPathList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filesinfolder</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">datapath</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AM&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">filesinfolder</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">folderPathList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
            <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;EH&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filesinfolder</span><span class="p">:</span>
            <span class="n">folderPathList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AM&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">fileList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fileList</span><span class="p">):</span>
        <span class="n">folderPathList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folderPathList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">folderPathList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folderPathList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">filepaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">folderPathList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folderPathList</span><span class="p">)</span> <span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">error</span><span class="p">(</span><span class="s1">&#39;3 channels needed!&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#filepaths = []</span>
        <span class="c1">#for folder in folderPathList:</span>
        <span class="c1">#    for file in folder.iterdir():</span>
        <span class="c1">#        if str(doy) in str(file.name) and str(year) in str(file.name):</span>
        <span class="c1">#            filepaths.append(file)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;No file found for specified day/year. The following days/files exist for specified year in this directory&#39;</span><span class="p">)</span>
            <span class="n">doyList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folderPathList</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">doyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">doyList</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;%Y %j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;| Day of year:&#39;</span> <span class="p">,</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
        <span class="n">traceList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filepaths</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;^readMSEEDBuffer()&#39;</span><span class="p">)</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">starttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]),</span> <span class="n">endttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]),</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#tr= obspy.Trace(tr.data,header=meta)</span>
                <span class="n">traceList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">traceList</span><span class="p">)</span>
        <span class="n">rawDataIN</span><span class="o">.</span><span class="n">attach_response</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rawDataIN</span>

<span class="c1">#Trim data </span>
<div class="viewcode-block" id="trim_data"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.trim_data">[docs]</a><span class="k">def</span> <span class="nf">trim_data</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">export_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to trim data to start and end time</span>

<span class="sd">        Trim data to start and end times so that stream being analyzed only contains wanted data.</span>
<span class="sd">        Can also export data to specified directory using a specified site name and/or export_format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            stream  : obspy.stream object  </span>
<span class="sd">                Obspy stream to be trimmed</span>
<span class="sd">            params  : dict</span>
<span class="sd">                Dictionary containing input parameters for trimming</span>
<span class="sd">            export_dir: str or pathlib obj   </span>
<span class="sd">                Output file to export trimmed data to            </span>
<span class="sd">            export_format  : str or True    </span>
<span class="sd">                If not specified, does not export. </span>
<span class="sd">                    Otherwise, exports trimmed stream using obspy write function in format provided as string.</span>
<span class="sd">                If specified as True, defaults to .mseed</span>
<span class="sd">            outfile : str                   </span>
<span class="sd">                Exact filename to output</span>
<span class="sd">                    If not designated, uses default parameters (from input filename in standard seismic file format)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            st_trimmed  : obspy.stream object </span>
<span class="sd">                Obpsy Stream trimmed to start and end times</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>

    <span class="n">st_trimmed</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">trimStart</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">trimEnd</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="n">st_trimmed</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">trimStart</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">trimEnd</span><span class="p">)</span>

    <span class="c1">#Format export filepath, if exporting</span>
    <span class="k">if</span> <span class="n">export_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">site</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">export_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">site</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">site</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
        <span class="n">export_format</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">export_format</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span>
        <span class="n">strtD</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">strtT</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">strtT</span><span class="o">=</span><span class="n">strtT</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="n">endT</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">export_dir</span> <span class="o">=</span> <span class="n">checkifpath</span><span class="p">(</span><span class="n">export_dir</span><span class="p">)</span>
        <span class="n">export_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">export_dir</span><span class="p">)</span>
        <span class="n">export_dir</span> <span class="o">=</span> <span class="n">export_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">export_dir</span> <span class="o">=</span> <span class="n">export_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">export_format</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">site</span><span class="o">+</span><span class="n">net</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">sta</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">loc</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">strtD</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">strtT</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">endT</span><span class="o">+</span><span class="n">export_format</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">export_format</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">site</span><span class="o">+</span><span class="n">net</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">sta</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">loc</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">strtD</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">strtT</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">endT</span><span class="o">+</span><span class="s1">&#39;.mseed&#39;</span>

        <span class="k">if</span> <span class="n">export_dir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">export_dir</span><span class="o">=</span><span class="n">export_dir</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">exportFile</span> <span class="o">=</span> <span class="n">export_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">filename</span>

        <span class="n">st_trimmed</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">exportFile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">st_trimmed</span></div>

<span class="c1">#Generate PPSDs for each channel</span>
<span class="c1">#def generate_ppsds(params, stream, ppsd_length=60, **kwargs):</span>
<div class="viewcode-block" id="generate_ppsds"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.generate_ppsds">[docs]</a><span class="k">def</span> <span class="nf">generate_ppsds</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates PPSDs for each channel</span>

<span class="sd">        Channels need to be in Z, N, E order</span>
<span class="sd">        Info on PPSD creation here: https://docs.obspy.org/packages/autogen/obspy.signal.spectral_estimation.PPSD.html</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            stream  :   obspy.stream object </span>
<span class="sd">                Obspy data stream from which to pull data</span>
<span class="sd">            paz     :   dict</span>
<span class="sd">                Dictionary containing dictionaries containing poles and zeros (paz) info for each channel, from inventory file or other metadata</span>
<span class="sd">            ppsd_length :  int</span>
<span class="sd">                length of data passed to psd, in seconds. Per obspy: Longer segments increase the upper limit of analyzed periods but decrease the number of analyzed segments.</span>
<span class="sd">            **kwargs : dict</span>
<span class="sd">                Dictionary with keyword arguments that can be passed to obspy.signal.PPSD</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            ppsds   :   dict</span>
<span class="sd">                Dictionary containing entries with ppsds for each channel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paz</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">]</span>

    <span class="kn">from</span> <span class="nn">obspy.imaging.cm</span> <span class="kn">import</span> <span class="n">viridis_white_r</span>
    <span class="kn">from</span> <span class="nn">obspy.signal</span> <span class="kn">import</span> <span class="n">PPSD</span>
    <span class="n">ppsdE</span> <span class="o">=</span> <span class="n">PPSD</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;EHE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="n">paz</span><span class="p">[</span><span class="s1">&#39;EHE&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1">#ppsdE = PPSD(stream.select(channel=&#39;EHE&#39;).traces[0].stats, paz[&#39;EHE&#39;], ppsd_length=ppsd_length, kwargs=kwargs)</span>
    <span class="n">ppsdE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ppsdN</span> <span class="o">=</span> <span class="n">PPSD</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;EHN&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="n">paz</span><span class="p">[</span><span class="s1">&#39;EHN&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ppsdN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ppsdZ</span> <span class="o">=</span> <span class="n">PPSD</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;EHZ&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="n">paz</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ppsdZ</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ppsds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;EHZ&#39;</span><span class="p">:</span><span class="n">ppsdZ</span><span class="p">,</span> <span class="s1">&#39;EHN&#39;</span><span class="p">:</span><span class="n">ppsdN</span><span class="p">,</span> <span class="s1">&#39;EHE&#39;</span><span class="p">:</span><span class="n">ppsdE</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppsds</span>
    <span class="k">return</span> <span class="n">params</span></div>

<span class="c1">#Check the x-values for each cahnnel, to make sure they are all the same length</span>
<span class="k">def</span> <span class="nf">__check_xvalues</span><span class="p">(</span><span class="n">ppsds</span><span class="p">):</span>
    <span class="n">xLengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ppsds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">xLengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">period_bin_centers</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">xLengths</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c1">#This means all channels have same number of period_bin_centers</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X-values (periods or frequencies) do not have the same values. </span><span class="se">\n</span><span class="s1"> This may result in computational errors&#39;</span><span class="p">)</span>
        <span class="c1">#Do stuff to fix it?</span>
    <span class="k">return</span> <span class="n">ppsds</span>

<span class="c1">#Check to make the number of time-steps are the same for each channel</span>
<span class="k">def</span> <span class="nf">__check_tsteps</span><span class="p">(</span><span class="n">ppsds</span><span class="p">):</span>
    <span class="n">tSteps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ppsds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tSteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">psd_values</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tSteps</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c1">#This means all channels have same number of period_bin_centers</span>
        <span class="n">minTStep</span><span class="o">=</span><span class="n">tSteps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There is a different number of time-steps used to calculate HVSR curves. </span><span class="se">\n</span><span class="s1"> This may result in computational errors. Trimming longest.&#39;</span><span class="p">)</span>
        <span class="n">minTStep</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tSteps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">minTStep</span>

<span class="c1">#Main function for processing HVSR Curve</span>
<div class="viewcode-block" id="process_hvsr"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.process_hvsr">[docs]</a><span class="k">def</span> <span class="nf">process_hvsr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process the input data and get HVSR data</span>
<span class="sd">    </span>
<span class="sd">    This is the main function that uses other (private) functions to do </span>
<span class="sd">    the bulk of processing of the HVSR data and the data quality checks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        ppsds   : dict  </span>
<span class="sd">            Dictionary with three key-value pairs containing the PPSD outputs from the three channels from the genereate_ppsds function</span>
<span class="sd">        method  : int or str</span>
<span class="sd">            Method to use for combining the horizontal components</span>
<span class="sd">                0) Diffuse field assumption, or &#39;DFA&#39; (not currently supported)</span>
<span class="sd">                1) &#39;Arithmetic Mean&#39;: H ≡ (HN + HE)/2</span>
<span class="sd">                2) &#39;Geometric Mean&#39;: H ≡ √HN · HE, recommended by the SESAME project (2004)</span>
<span class="sd">                3) &#39;Vector Summation&#39;: H ≡ √H2 N + H2 E</span>
<span class="sd">                4) &#39;Quadratic Mean&#39;: H ≡ √(H2 N + H2 E )/2</span>
<span class="sd">                5) &#39;Maximum Horizontal Value&#39;: H ≡ max {HN, HE}</span>
<span class="sd">        params  : dict</span>
<span class="sd">            Dictionary containing all the parameters input by the user</span>
<span class="sd">        smooth  : bool=True</span>
<span class="sd">            bool or int. </span>
<span class="sd">                If True, default to smooth hvsr curve to using savgoy filter with window length of 51 (works well with default resample of 1000 pts)</span>
<span class="sd">                If int, the length of the window in the savgoy filter. </span>
<span class="sd">        resample  : bool=True</span>
<span class="sd">            bool or int. </span>
<span class="sd">                If True, default to resample data to include 1000 frequency values for the rest of the analysis</span>
<span class="sd">                If int, the number of data points to interpolate/resample/smooth the component psd/HV curve data to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        hvsr_out    : dict</span>
<span class="sd">            Dictionary containing all the information about the data, including input parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ppsds</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span>
    <span class="n">ppsds</span> <span class="o">=</span> <span class="n">__check_xvalues</span><span class="p">(</span><span class="n">ppsds</span><span class="p">)</span>
    <span class="n">resample</span><span class="o">=</span><span class="kc">True</span>

    <span class="n">methodList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Diffuse Field Assumption&#39;</span><span class="p">,</span> <span class="s1">&#39;Arithmetic Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Geometric Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Vector Summation&#39;</span><span class="p">,</span> <span class="s1">&#39;Quadratic Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Maximum Horizontal Value&#39;</span><span class="p">]</span>
    <span class="n">x_freqs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">x_periods</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">psdVals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stDev</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stDevValsP</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stDevValsM</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">psdRaw</span><span class="o">=</span><span class="p">{}</span>    
    
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ppsds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">resample</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">resample</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
                <span class="n">resample</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1">#Default smooth value</span>

            <span class="n">xValMin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">period_bin_centers</span><span class="p">)</span>
            <span class="n">xValMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">period_bin_centers</span><span class="p">)</span>

            <span class="c1">#Resample period bin values</span>
            <span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xValMin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xValMax</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">smooth</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
                    <span class="n">smooth</span> <span class="o">=</span> <span class="mi">51</span> <span class="c1">#Default smoothing window</span>
                <span class="k">elif</span> <span class="n">smooth</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">smooth</span> <span class="o">=</span> <span class="n">smooth</span><span class="o">+</span><span class="mi">1</span>


            <span class="c1">#Resample raw ppsd values</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">psd_values</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">period_bin_centers</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">smooth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                        <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span> <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">smooth</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">period_bin_centers</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">smooth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span> <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">smooth</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                <span class="c1">#print(psdRaw[k].shape)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#If no resampling desired</span>
            <span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">period_bin_centers</span><span class="p">)</span>
            <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">psd_values</span><span class="p">)</span>

        <span class="c1">#Get average psd value across time for each channel (used to calc H/V curve)</span>
        <span class="n">psdVals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x_freqs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> 

        <span class="n">stDev</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">stDevValsM</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psdVals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">stDev</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">stDevValsP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psdVals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">stDev</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="c1">#This gets the hvsr curve averaged from all time steps</span>
    <span class="n">anyK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_freqs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hvsr_curve</span> <span class="o">=</span> <span class="n">__get_hvsr_curve</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_freqs</span><span class="p">[</span><span class="n">anyK</span><span class="p">],</span> <span class="n">psd</span><span class="o">=</span><span class="n">psdVals</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    
    <span class="c1">#Get string of method type</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">methodList</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>

    <span class="c1">#Add some other variables to our output dictionary</span>
    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input_params&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">,</span>
                <span class="s1">&#39;x_freqs&#39;</span><span class="p">:</span><span class="n">x_freqs</span><span class="p">,</span>
                <span class="s1">&#39;hvsr_curve&#39;</span><span class="p">:</span><span class="n">hvsr_curve</span><span class="p">,</span>
                <span class="s1">&#39;x_period&#39;</span><span class="p">:</span><span class="n">x_periods</span><span class="p">,</span>
                <span class="s1">&#39;psd_values&#39;</span><span class="p">:</span><span class="n">psdVals</span><span class="p">,</span>
                <span class="s1">&#39;psd_raw&#39;</span><span class="p">:</span><span class="n">psdRaw</span><span class="p">,</span>
                <span class="s1">&#39;ppsd_std&#39;</span><span class="p">:</span><span class="n">stDev</span><span class="p">,</span>
                <span class="s1">&#39;ppsd_std_vals_m&#39;</span><span class="p">:</span><span class="n">stDevValsM</span><span class="p">,</span>
                <span class="s1">&#39;ppsd_std_vals_p&#39;</span><span class="p">:</span><span class="n">stDevValsP</span><span class="p">,</span>
                <span class="s1">&#39;method&#39;</span><span class="p">:</span><span class="n">method</span><span class="p">,</span>
                <span class="s1">&#39;ppsds&#39;</span><span class="p">:</span><span class="n">ppsds</span>
                <span class="p">}</span>
    
    <span class="c1">#Get hvsr curve from three components at each time step</span>
    <span class="n">hvsr_tSteps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anyK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tStep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">])):</span>
        <span class="n">tStepDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]:</span>
            <span class="n">tStepDict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">tStep</span><span class="p">]</span>
        <span class="n">hvsr_tSteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__get_hvsr_curve</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">],</span> <span class="n">psd</span><span class="o">=</span><span class="n">tStepDict</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">))</span>
    <span class="n">hvsr_tSteps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsr_tSteps</span><span class="p">)</span>
    
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_tSteps</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">hvsr_tSteps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#hvsr_out[&#39;ind_hvsr_stdDev_median&#39;] = np.median(hvsr_tSteps, axis=0)</span>


    <span class="n">tStepPeaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tStepHVSR</span> <span class="ow">in</span> <span class="n">hvsr_tSteps</span><span class="p">:</span>
        <span class="n">tStepPeaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__find_peaks</span><span class="p">(</span><span class="n">tStepHVSR</span><span class="p">))</span>
    <span class="c1">#tStepPeaks = np.array(tStepPeaks) #This is a list of lists, and the individual lists are different sizes</span>

    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_peak_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tStepPeaks</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__find_peaks</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">])</span>
    <span class="n">hvsrPF</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">]:</span>
        <span class="n">hvsrPF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">][</span><span class="n">p</span><span class="p">])</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_freqs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsrPF</span><span class="p">)</span>

    <span class="c1">#Get other HVSR parameters (i.e., standard deviations, water levels, etc.)</span>
    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">__gethvsrparams</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_out</span></div>

<span class="c1">#Diffuse field assumption, not currently implemented</span>
<div class="viewcode-block" id="dfa"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.dfa">[docs]</a><span class="k">def</span> <span class="nf">dfa</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">day_time_values</span><span class="p">,</span> <span class="n">day_time_psd</span><span class="p">,</span> <span class="n">x_values</span><span class="p">,</span> <span class="n">equal_daily_energy</span><span class="p">,</span> <span class="n">median_daily_psd</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function for performing Diffuse Field Assumption (DFA) analysis</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Are we doing DFA?</span>
    <span class="c1"># Use equal energy for daily PSDs to give small &#39;events&#39; a chance to contribute</span>
    <span class="c1"># the same as large ones, so that P1+P2+P3=1</span>
    
    <span class="n">method</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
    
    <span class="n">methodList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Diffuse Field Assumption&#39;</span><span class="p">,</span> <span class="s1">&#39;Arithmetic Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Geometric Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Vector Summation&#39;</span><span class="p">,</span> <span class="s1">&#39;Quadratic Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Maximum Horizontal Value&#39;</span><span class="p">]</span>
    <span class="n">dfaList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">,</span> <span class="s1">&#39;diffuse field&#39;</span><span class="p">,</span> <span class="s1">&#39;diffuse field assumption&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">methodList</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">dfaList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[INFO] Diffuse Field Assumption&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">display</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sum_ns_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">sum_ew_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">sum_z_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">daily_psd</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{},</span> <span class="p">{}]</span>
        <span class="n">day_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Make sure we have all 3 components for every time sample</span>
        <span class="k">for</span> <span class="n">day_time</span> <span class="ow">in</span> <span class="n">day_time_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">day_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">day_time_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="n">day_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">day_time_psd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="n">day_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">day_time_psd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">continue</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">day_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">day</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">day_values</span><span class="p">:</span>
                <span class="n">day_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>

            <span class="c1"># Initialize the daily PSDs.</span>
            <span class="k">if</span> <span class="n">day</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">daily_psd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">daily_psd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

            <span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_time_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day_time</span><span class="p">])</span>
            <span class="n">daily_psd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">day</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_time_psd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">day_time</span><span class="p">])</span>
            <span class="n">daily_psd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">day</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_time_psd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">day_time</span><span class="p">])</span>

        <span class="c1"># For each day equalize energy</span>
        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">day_values</span><span class="p">:</span>

            <span class="c1"># Each PSD for the day</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">])):</span>
                <span class="n">Pz</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">P1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">P2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">sum_pz</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sum_p1</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sum_p2</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Each sample of the PSD , convert to power</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">pz</span> <span class="o">=</span> <span class="n">hvsrCalcs</span><span class="o">.</span><span class="n">get_power</span><span class="p">([</span><span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">x_values</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">x_values</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
                    <span class="n">Pz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pz</span><span class="p">)</span>
                    <span class="n">sum_pz</span> <span class="o">+=</span> <span class="n">pz</span>
                    <span class="n">p1</span> <span class="o">=</span> <span class="n">hvsrCalcs</span><span class="o">.</span><span class="n">get_power</span><span class="p">([</span><span class="n">daily_psd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">day</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">daily_psd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">day</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">x_values</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">x_values</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
                    <span class="n">P1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
                    <span class="n">sum_p1</span> <span class="o">+=</span> <span class="n">p1</span>
                    <span class="n">p2</span> <span class="o">=</span> <span class="n">hvsrCalcs</span><span class="o">.</span><span class="n">get_power</span><span class="p">([</span><span class="n">daily_psd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">day</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">daily_psd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">day</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">x_values</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">x_values</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
                    <span class="n">P2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
                    <span class="n">sum_p2</span> <span class="o">+=</span> <span class="n">p2</span>

                <span class="n">sum_power</span> <span class="o">=</span> <span class="n">sum_pz</span> <span class="o">+</span> <span class="n">sum_p1</span> <span class="o">+</span> <span class="n">sum_p2</span>  <span class="c1"># total power</span>

                <span class="c1"># Mormalized power</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Initialize if this is the first sample of the day</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sum_z_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pz</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
                        <span class="n">sum_ns_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
                        <span class="n">sum_ew_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sum_z_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">Pz</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
                        <span class="n">sum_ns_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
                        <span class="n">sum_ew_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">P2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
            <span class="c1"># Average the normalized daily power</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">sum_z_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">])</span>
                <span class="n">sum_ns_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">])</span>
                <span class="n">sum_ew_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">daily_psd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">])</span>

            <span class="n">equal_daily_energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_z_power</span>
            <span class="n">equal_daily_energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_ns_power</span>
            <span class="n">equal_daily_energy</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_ew_power</span>

    <span class="k">return</span> 

    
    <span class="k">return</span></div>

<span class="c1">#Get an HVSR curve, given an array of x values (freqs), and a dict with psds for three components</span>
<span class="k">def</span> <span class="nf">__get_hvsr_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Get an HVSR curve from three components over the same time period/frequency intervals</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        x   : list or array_like</span>
<span class="sd">            x value (frequency or period)</span>
<span class="sd">        psd = 3-component dictionary</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        hvsr_curve  : list</span>
<span class="sd">            List containing H/V ratios at each frequency/period in x</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span><span class="s1">&#39;dfa&#39;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;Diffuse Field Assumption&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">hvsr_curve</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">psd0</span> <span class="o">=</span> <span class="p">[</span><span class="n">psd</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">psd</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">psd1</span> <span class="o">=</span> <span class="p">[</span><span class="n">psd</span><span class="p">[</span><span class="s1">&#39;EHE&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">psd</span><span class="p">[</span><span class="s1">&#39;EHE&#39;</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">psd2</span> <span class="o">=</span> <span class="p">[</span><span class="n">psd</span><span class="p">[</span><span class="s1">&#39;EHN&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">psd</span><span class="p">[</span><span class="s1">&#39;EHN&#39;</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">f</span> <span class="o">=</span>    <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="n">hvsr</span> <span class="o">=</span> <span class="n">__get_hvsr</span><span class="p">(</span><span class="n">psd0</span><span class="p">,</span> <span class="n">psd1</span><span class="p">,</span> <span class="n">psd2</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">use_method</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">hvsr_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr</span><span class="p">)</span>  

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsr_curve</span><span class="p">)</span>

<span class="c1">#Get additional HVSR params for later calcualtions</span>
<span class="k">def</span> <span class="nf">__gethvsrparams</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">):</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1">#SOMETHING VERY WRONG IS GOING ON HERE!!!!</span>
    <span class="n">hvsrp2</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hvsrm2</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">peak_water_level</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hvsr_std</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1">#hvsr_log_std=[]</span>
    <span class="n">peak_water_level_p</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">hvsrp2</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">hvsrm</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">peak_water_level_m</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">water_level</span><span class="o">=</span><span class="mf">1.8</span> <span class="c1">#Make this an input parameter eventually!!!****</span>
    
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">hvsr_log_std</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">peak_water_level</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">water_level</span><span class="p">)</span>

    <span class="n">hvsr</span><span class="o">=</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hvsrp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">],</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">])</span>
        <span class="n">hvsrm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">],</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">])</span>

        <span class="c1">#ppsd_std = hvsr_out[&#39;ppsd_std&#39;]</span>
        <span class="n">hvsr_log_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hvsrp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">hvsr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">hvsr_log_std</span><span class="p">))</span>
        <span class="n">hvsrm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">hvsr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">hvsr_log_std</span><span class="p">))</span>

        <span class="n">peak_water_level_p</span> <span class="o">=</span> <span class="n">water_level</span> <span class="o">+</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">]</span>
        <span class="n">peak_water_level_m</span> <span class="o">=</span> <span class="n">water_level</span> <span class="o">-</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">]</span>

    <span class="n">newKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr_log_std&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_water_level&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_water_level_p&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_water_level_m&#39;</span><span class="p">,</span><span class="s1">&#39;hvsrp&#39;</span><span class="p">,</span><span class="s1">&#39;hvsrm&#39;</span><span class="p">,</span> <span class="s1">&#39;hvsrp2&#39;</span><span class="p">,</span><span class="s1">&#39;hvsrm2&#39;</span><span class="p">]</span>
    <span class="n">newVals</span> <span class="o">=</span> <span class="p">[</span><span class="n">hvsr_log_std</span><span class="p">,</span>    <span class="n">peak_water_level</span><span class="p">,</span>   <span class="n">peak_water_level_p</span><span class="p">,</span>   <span class="n">peak_water_level_m</span><span class="p">,</span>  <span class="n">hvsrp</span><span class="p">,</span>  <span class="n">hvsrm</span><span class="p">,</span>   <span class="n">hvsrp2</span><span class="p">,</span>  <span class="n">hvsrm2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newKeys</span><span class="p">):</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newVals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">hvsr_out</span>

<span class="c1">#Plot HVSR data</span>
<div class="viewcode-block" id="hvplot"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.hvplot">[docs]</a><span class="k">def</span> <span class="nf">hvplot</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;HVSR&#39;</span><span class="p">,</span> <span class="n">xtype</span><span class="o">=</span><span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="n">returnfig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to plot HVSR data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hvsr_dict   : dict                  </span>
<span class="sd">            Dictionary containing output from process_hvsr function</span>
<span class="sd">        kind        : str=&#39;HVSR&#39; or list    </span>
<span class="sd">            The kind of plot(s) to plot. If list, will plot all plots listed</span>
<span class="sd">            &#39;HVSR&#39;  : Standard HVSR plot, including standard deviation</span>
<span class="sd">            - &#39;[HVSR] c&#39; :HVSR plot with each components&#39; spectra</span>
<span class="sd">            - &#39;[HVSR] p&#39; :HVSR plot with best peaks shown</span>
<span class="sd">            - &#39;[HVSR] p&#39; : HVSR plot with best picked peak shown                </span>
<span class="sd">            - &#39;[HVSR] p* all&#39; : HVSR plot with all picked peaks shown                </span>
<span class="sd">            - &#39;[HVSR] p* t&#39; : HVSR plot with peaks from all time steps in background                </span>
<span class="sd">            - &#39;[HVSR p* ann]  : Annotates plot with peaks</span>
<span class="sd">            - &#39;[HVSR] -s&#39; : HVSR plots don&#39;t show standard deviation</span>
<span class="sd">            - &#39;[HVSR] t&#39;  : HVSR plot with individual hv curves for each time step shown</span>
<span class="sd">            &#39;Specgram&#39;: Combined spectrogram of all components</span>
<span class="sd">        xtype       : str=&#39;freq&#39;    </span>
<span class="sd">            String for what to use between frequency or period</span>
<span class="sd">                For frequency, the following are accepted (case does not matter): &#39;f&#39;, &#39;Hz&#39;, &#39;freq&#39;, &#39;frequency&#39;</span>
<span class="sd">                For period, the following are accepted (case does not matter): &#39;p&#39;, &#39;T&#39;, &#39;s&#39;, &#39;sec&#39;, &#39;second&#39;, &#39;per&#39;, &#39;period&#39;</span>
<span class="sd">        returnfig   : bool</span>
<span class="sd">            Whether to return figure and axis objects</span>
<span class="sd">        save_dir     : str or None</span>
<span class="sd">            Directory in which to save figures</span>
<span class="sd">        save_suffix  : str</span>
<span class="sd">            Suffix to add to end of figure filename(s), if save_dir is used</span>
<span class="sd">        show    : bool</span>
<span class="sd">            Whether to show plot</span>
<span class="sd">        **kwargs    : keyword arguments</span>
<span class="sd">            Keyword arguments for matplotlib.pyplot (still working on this)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, ax : matplotlib figure and axis objects</span>
<span class="sd">            Returns figure and axis matplotlib.pyplot objects if returnfig=True, otherwise, simply plots the figures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">freqList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;HZ&#39;</span><span class="p">,</span> <span class="s1">&#39;FREQ&#39;</span><span class="p">,</span> <span class="s1">&#39;FREQUENCY&#39;</span><span class="p">]</span>
    <span class="n">perList</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC&#39;</span><span class="p">,</span> <span class="s1">&#39;SECOND&#39;</span> <span class="s1">&#39;PER&#39;</span><span class="p">,</span> <span class="s1">&#39;PERIOD&#39;</span>

    <span class="k">if</span> <span class="n">xtype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">freqList</span><span class="p">:</span>
        <span class="n">xtype</span><span class="o">=</span><span class="s1">&#39;x_freqs&#39;</span>
    <span class="k">elif</span> <span class="n">xtype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">perList</span><span class="p">:</span>
        <span class="n">xtype</span><span class="o">=</span><span class="s1">&#39;x_period&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;xtype not valid&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="c1">#iterate through and plot in separate (sub)plots</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kind</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;HVSR&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">__plot_hvsr</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span>  <span class="n">savedir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;specgram&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;spectrogram&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">__plot_specgram</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span>  <span class="n">savedir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#Just a single plot</span>
        <span class="k">if</span> <span class="s1">&#39;HVSR&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">__plot_hvsr</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span>  <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;specgram&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;spectrogram&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">__plot_specgram</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span>  <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">returnfig</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
    
    <span class="k">return</span></div>
    
<span class="c1">#Plot hvsr curve, private supporting function for hvplot</span>
<span class="k">def</span> <span class="nf">__plot_hvsr</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function for plotting hvsr curve (or curves with components)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;xlim&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xlim&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="s1">&#39;ylim&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsrp2&#39;</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ylim&#39;</span><span class="p">]</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;grid&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xtype</span><span class="o">==</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Frequency [Hz]&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Period [s]&#39;</span>

    <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>


    <span class="n">anyKey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="n">xtype</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="n">xtype</span><span class="p">][</span><span class="n">anyKey</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">]</span>
    
    <span class="c1">#hvsr_std={}</span>
    <span class="c1">#for i, k in enumerate(hvsr_dict[&#39;hvsr_std&#39;]):</span>
    <span class="c1">#    hvsr_std[k]=hvsr_dict[&#39;hvsr_std&#39;][k][:-1].copy()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[&#39;</span><span class="o">+</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

    <span class="n">plotSuff</span><span class="o">=</span><span class="s1">&#39;HVSRCurve_&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;-s&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsrm2&#39;</span><span class="p">],</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsrp2&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;StDev&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;noStdDev_&#39;</span>

    <span class="k">if</span> <span class="s1">&#39; p &#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;all&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;+p&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
                        <span class="n">plot_suffix</span><span class="o">=</span><span class="n">plotSuff</span><span class="p">,</span> 
                        <span class="n">user_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>            
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">ax</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>            
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[m2/s4/Hz] [dB]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
        
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="s1">&#39;HVSR_&#39;</span>
        <span class="n">plotSuff</span><span class="o">=</span><span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;BestPeak_&#39;</span>

        <span class="n">bestPeakScore</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;Peak Report&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bestPeakScore</span><span class="p">:</span>
                <span class="n">bestPeak</span> <span class="o">=</span> <span class="n">p</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">bestPeak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peak&#39;</span><span class="p">)</span>          
        <span class="k">if</span> <span class="s1">&#39;ann&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Peak at &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">bestPeak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">bestPeak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> 
                            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> 
                            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;ann_&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39; p &#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;+p&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
                        <span class="n">plot_suffix</span><span class="o">=</span><span class="n">plotSuff</span><span class="p">,</span> 
                        <span class="n">user_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">ax</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>            
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[m2/s4/Hz] [dB]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="s1">&#39;HVSR_&#39;</span>
        <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;allPeaks_&#39;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_freqs&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peak&#39;</span><span class="p">)</span>          
        <span class="k">if</span> <span class="s1">&#39;ann&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_freqs&#39;</span><span class="p">]):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">][</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Peak at &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> 
                                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> 
                                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
            <span class="n">plot_suffix</span><span class="o">=</span><span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;ann_&#39;</span>
            <span class="c1">#__plot_current_fig(save_dir=save_dir, filename=filename, </span>
            <span class="c1">#            plot_suffix=plotSuff+&#39;ann_&#39;, </span>
            <span class="c1">#            user_suffix=save_suffix)</span>

    <span class="k">if</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;+t&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
                        <span class="n">plot_suffix</span><span class="o">=</span><span class="n">plotSuff</span><span class="p">,</span> 
                        <span class="n">user_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">ax</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>            
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[m2/s4/Hz] [dB]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="s1">&#39;HVSR_&#39;</span>
        <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;allTWinCurves_&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;tp&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_peak_indices&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">v</span><span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">16</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">16</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">],</span><span class="n">v</span><span class="o">-</span><span class="n">width</span><span class="p">,</span><span class="n">v</span><span class="o">+</span><span class="n">width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Individual H/V Peaks&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">]:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;+t&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
           <span class="n">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
                        <span class="n">plot_suffix</span><span class="o">=</span><span class="n">plotSuff</span><span class="p">,</span> 
                        <span class="n">user_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;+c&#39;</span> <span class="ow">in</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="n">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
                        <span class="n">plot_suffix</span><span class="o">=</span><span class="n">plotSuff</span><span class="p">,</span> 
                        <span class="n">user_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">ax</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>            
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[m2/s4/Hz] [dB]&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="s1">&#39;IndComponents_&#39;</span>

            <span class="n">linalpha</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">stdalpha</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;IndComponents_&#39;</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="n">linalpha</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">stdalpha</span> <span class="o">=</span> <span class="mf">0.02</span>

        <span class="c1">#Plot individual components</span>
        <span class="n">y</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;psd_values&#39;</span><span class="p">]:</span>
            <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;psd_values&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;EHZ&#39;</span><span class="p">:</span>
                <span class="n">pltColor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span><span class="s1">&#39;EHE&#39;</span><span class="p">:</span>
                <span class="n">pltColor</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;EHN&#39;</span><span class="p">:</span>
                <span class="n">pltColor</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">pltColor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">linalpha</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;ppsd_std_vals_m&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;ppsd_std_vals_p&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">pltColor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">stdalpha</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="n">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
                <span class="n">plot_suffix</span><span class="o">=</span><span class="n">plotSuff</span><span class="p">,</span> 
                <span class="n">user_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

<span class="k">def</span> <span class="nf">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">plot_suffix</span><span class="p">,</span> <span class="n">user_suffix</span><span class="p">,</span> <span class="n">show</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="n">save_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">plot_suffix</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">user_suffix</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="k">return</span>

<span class="c1">#Plot specgtrogram, private supporting function for hvplot</span>
<span class="k">def</span> <span class="nf">__plot_specgram</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function for plotting average spectrogram of all three channels from ppsds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>
    <span class="n">ppsds</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>

    <span class="n">psdList</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]:</span>
        <span class="n">psdList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
    <span class="n">psdArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psdList</span><span class="p">)</span>
    <span class="n">psdArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psdArr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;detrend&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;detrend&#39;</span><span class="p">]:</span>
            <span class="n">psdArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">psdArr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">psdArr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;detrend&#39;</span><span class="p">]</span>

    <span class="n">xmin</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">current_times_used</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">current_times_used</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>

    <span class="n">tTicks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tLabels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">current_times_used</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tTicks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
        <span class="n">day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">10</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">tLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    <span class="n">extList</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="s1">&#39;EHZ&#39;</span><span class="p">]),</span><span class="nb">max</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="s1">&#39;EHZ&#39;</span><span class="p">])]</span>
    <span class="k">if</span> <span class="s1">&#39;cmap&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psdArr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extList</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">.005</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="c1">#,cmap=cmap)</span>
  
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

    <span class="n">FreqTicks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="s1">&#39;EHZ&#39;</span><span class="p">]),</span><span class="mi">0</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">tTicks</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">tLabels</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">FreqTicks</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">day</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency [Hz]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="o">=</span><span class="n">im</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

<span class="c1">#Get HVSR</span>
<span class="k">def</span> <span class="nf">__get_hvsr</span><span class="p">(</span><span class="n">_dbz</span><span class="p">,</span> <span class="n">_db1</span><span class="p">,</span> <span class="n">_db2</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">use_method</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    H is computed based on the selected use_method see: https://academic.oup.com/gji/article/194/2/936/597415</span>
<span class="sd">        use_method:</span>
<span class="sd">           (1) Diffuse Field Assumption (DFA)</span>
<span class="sd">           (2) arithmetic mean, that is, H ≡ (HN + HE)/2</span>
<span class="sd">           (3) geometric mean, that is, H ≡ √HN · HE, recommended by the SESAME project (2004)</span>
<span class="sd">           (4) vector summation, that is, H ≡ √H2 N + H2 E</span>
<span class="sd">           (5) quadratic mean, that is, H ≡ √(H2 N + H2 E )/2</span>
<span class="sd">           (6) maximum horizontal value, that is, H ≡ max {HN, HE}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_pz</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">(</span><span class="n">_dbz</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
    <span class="n">_p1</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">(</span><span class="n">_db1</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
    <span class="n">_p2</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">(</span><span class="n">_db2</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>

    <span class="n">_hz</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_pz</span><span class="p">)</span>
    <span class="n">_h1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_p1</span><span class="p">)</span>
    <span class="n">_h2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_p2</span><span class="p">)</span>

    <span class="n">_h</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="n">_h1</span> <span class="o">+</span> <span class="n">_h2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> 
            <span class="mi">3</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_h1</span> <span class="o">*</span> <span class="n">_h2</span><span class="p">),</span> 
            <span class="mi">4</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_p1</span> <span class="o">+</span> <span class="n">_p2</span><span class="p">),</span> 
            <span class="mi">5</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">_p1</span> <span class="o">+</span> <span class="n">_p2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
            <span class="mi">6</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">_h1</span><span class="p">,</span> <span class="n">_h2</span><span class="p">)}</span>

    <span class="n">_hvsr</span> <span class="o">=</span> <span class="n">_h</span><span class="p">[</span><span class="n">use_method</span><span class="p">]</span> <span class="o">/</span> <span class="n">_hz</span>
    <span class="k">return</span> <span class="n">_hvsr</span>

<span class="c1">#Remove decibel scaling</span>
<span class="k">def</span> <span class="nf">__remove_db</span><span class="p">(</span><span class="n">_db_value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;convert dB power to power&quot;&quot;&quot;</span>
    <span class="n">_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_d</span> <span class="ow">in</span> <span class="n">_db_value</span><span class="p">:</span>
        <span class="n">_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_d</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_values</span>

<span class="c1">#For converting dB scaled data to power units</span>
<span class="k">def</span> <span class="nf">__get_power</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">_x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;calculate HVSR</span>
<span class="sd">      We will undo setp 6 of MUSTANG processing as outlined below:</span>
<span class="sd">          1. Dividing the window into 13 segments having 75% overlap</span>
<span class="sd">          2. For each segment:</span>
<span class="sd">             2.1 Removing the trend and mean</span>
<span class="sd">             2.2 Apply a 10% sine taper</span>
<span class="sd">             2.3 FFT</span>
<span class="sd">          3. Calculate the normalized PSD</span>
<span class="sd">          4. Average the 13 PSDs &amp; scale to compensate for tapering</span>
<span class="sd">          5. Frequency-smooth the averaged PSD over 1-octave intervals at 1/8-octave increments</span>
<span class="sd">          6. Convert power to decibels</span>

<span class="sd">    NOTE: PSD is equal to the power divided by the width of the bin</span>
<span class="sd">          PSD = P / W</span>
<span class="sd">          log(PSD) = Log(P) - log(W)</span>
<span class="sd">          log(P) = log(PSD) + log(W)  here W is width in frequency</span>
<span class="sd">          log(P) = log(PSD) - log(Wt) here Wt is width in period</span>

<span class="sd">    for each bin perform rectangular integration to compute power</span>
<span class="sd">    power is assigned to the point at the begining of the interval</span>
<span class="sd">         _   _</span>
<span class="sd">        | |_| |</span>
<span class="sd">        |_|_|_|</span>

<span class="sd">     Here we are computing power for individual ponts, so, no integration is necessary, just</span>
<span class="sd">     compute area</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#print(_db)</span>
    <span class="n">_dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">_x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#print(_dx)</span>
    <span class="n">_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">__remove_db</span><span class="p">(</span><span class="n">_db</span><span class="p">)),</span> <span class="n">_dx</span><span class="p">)</span>
    <span class="c1">#print(_p)</span>
    <span class="k">return</span> <span class="n">_p</span>

<span class="c1">#Find peaks in the hvsr ccruve</span>
<span class="k">def</span> <span class="nf">__find_peaks</span><span class="p">(</span><span class="n">_y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;find peaks&quot;&quot;&quot;</span>
    <span class="n">_index_list</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_index_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">#Quality checks, stability tests, clarity tests</span>
<span class="c1">#def check_peaks(hvsr, x, y, index_list, peak, peakm, peakp, hvsr_peaks, stdf, hvsr_log_std, rank, hvsr_band=[0.4, 40], peak_water_level=1.8, do_rank=False):</span>
<div class="viewcode-block" id="check_peaks"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.check_peaks">[docs]</a><span class="k">def</span> <span class="nf">check_peaks</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="o">=</span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span> <span class="n">peak_water_level</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to run tests on HVSR peaks to find best one and see if it passes quality checks</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            hvsr : dict</span>
<span class="sd">                Dictionary containing all the calculated information about the HVSR data (i.e., hvsr_out returned from process_hvsr)</span>
<span class="sd">            hvsr_band  : tuple or list </span>
<span class="sd">                2-item tuple or list with lower and upper limit of frequencies to analyze</span>
<span class="sd">            peak_water_level: list-like obj </span>
<span class="sd">                List containing peak water level</span>
<span class="sd">            do_rank : bool=False    </span>
<span class="sd">                Include peak ranking in output</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            hvsr_dict   : dict</span>
<span class="sd">                Dictionary containing previous input data, plus information about Peak tests</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">hvsr_band</span><span class="p">:</span>
        <span class="n">hvsr_band</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">40</span><span class="p">]</span>
    <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_band</span>

    <span class="n">anyK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">]</span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">]</span>
    <span class="n">peak_water_level</span>  <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;peak_water_level&#39;</span><span class="p">]</span>
    <span class="n">hvsrp</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsrp&#39;</span><span class="p">]</span>
    <span class="n">peak_water_level_p</span>  <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;peak_water_level_p&#39;</span><span class="p">]</span>
    <span class="n">hvsrm</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsrm&#39;</span><span class="p">]</span>
    <span class="n">hvsrPeaks</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_peak_indices&#39;</span><span class="p">]</span>
    <span class="n">hvsr_log_std</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_log_std&#39;</span><span class="p">]</span>

    <span class="c1">#Do for hvsr</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">__init_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">index_list</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="p">,</span> <span class="n">peak_water_level</span><span class="p">)</span>

    <span class="n">peak</span> <span class="o">=</span> <span class="n">__check_curve_reliability</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span> <span class="n">peak</span><span class="p">)</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">__check_clarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#Do for hvsrp</span>
    <span class="c1"># Find  the relative extrema of hvsrp (hvsr + 1 standard deviation)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hvsrp</span><span class="p">)):</span>
        <span class="n">index_p</span> <span class="o">=</span> <span class="n">__find_peaks</span><span class="p">(</span><span class="n">hvsrp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="n">peakp</span> <span class="o">=</span> <span class="n">__init_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsrp</span><span class="p">,</span> <span class="n">index_p</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="p">,</span> <span class="n">peak_water_level_p</span><span class="p">)</span>
    <span class="n">peakp</span> <span class="o">=</span> <span class="n">__check_clarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsrp</span><span class="p">,</span> <span class="n">peakp</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#Do for hvsrm</span>
    <span class="c1"># Find  the relative extrema of hvsrm (hvsr - 1 standard deviation)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hvsrm</span><span class="p">)):</span>
        <span class="n">index_m</span> <span class="o">=</span> <span class="n">__find_peaks</span><span class="p">(</span><span class="n">hvsrm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index_m</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="n">peak_water_level_m</span>  <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;peak_water_level_m&#39;</span><span class="p">]</span>

    <span class="n">peakm</span> <span class="o">=</span> <span class="n">__init_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsrm</span><span class="p">,</span> <span class="n">index_m</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="p">,</span> <span class="n">peak_water_level_m</span><span class="p">)</span>
    <span class="n">peakm</span> <span class="o">=</span> <span class="n">__check_clarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsrm</span><span class="p">,</span> <span class="n">peakm</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="c1">###########FITURE OUT WHAT HVSRPEAKS IS, RELATIVE TO INDEX_LIST (AND INDEX_LIST??)</span>
    <span class="c1">#I think hvsrPeaks is list of peaks from each timestep</span>
    <span class="c1">#index_list is the indices of the main hvsr curve</span>
    <span class="c1">#get_stdf finds the closest peak from each timestep hvsr and uses that to compute a frequency std</span>

    <span class="n">stdf</span> <span class="o">=</span> <span class="n">__get_stdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index_list</span><span class="p">,</span> <span class="n">hvsrPeaks</span><span class="p">)</span>

    <span class="n">peak</span> <span class="o">=</span> <span class="n">__check_freq_stability</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">peakm</span><span class="p">,</span> <span class="n">peakp</span><span class="p">)</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">__check_stability</span><span class="p">(</span><span class="n">stdf</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">hvsr_log_std</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;Peak Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak</span>
    <span class="k">return</span> <span class="n">hvsr_dict</span></div>

<span class="c1">#Initialize peaks</span>
<span class="k">def</span> <span class="nf">__init_peaks</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_index_list</span><span class="p">,</span> <span class="n">_hvsr_band</span><span class="p">,</span> <span class="n">_peak_water_level</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Initialize peaks.</span>
<span class="sd">        </span>
<span class="sd">        Creates dictionary with relevant information and removes peaks in hvsr curve that are not relevant for data analysis (outside HVSR_band)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            x               : list-like obj </span>
<span class="sd">                List with x-values (frequency or period values)</span>
<span class="sd">            y               : list-like obj </span>
<span class="sd">                List with hvsr curve values ????</span>
<span class="sd">            index_list      : list-like obj </span>
<span class="sd">                List with indices of peaks</span>
<span class="sd">            _hvsr_band          :</span>
<span class="sd">            _peak_water_level   :</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            _peak               : list of dictionaries, one for each input peak</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_peak</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">_index_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_y</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_peak_water_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_hvsr_band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_x</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_hvsr_band</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">_peak</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;f0&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">_x</span><span class="p">[</span><span class="n">_i</span><span class="p">]),</span> <span class="s1">&#39;A0&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">_y</span><span class="p">[</span><span class="n">_i</span><span class="p">]),</span> 
                          <span class="s1">&#39;f-&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;f+&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Sf&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Sa&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;Score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                          <span class="s1">&#39;Report&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;A0&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;P+&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;P-&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Sf&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Sa&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
                          <span class="s1">&#39;Pass List&#39;</span><span class="p">:{}})</span>
    <span class="k">return</span> <span class="n">_peak</span>

<span class="c1">#Check reliability of HVSR of curve</span>
<span class="k">def</span> <span class="nf">__check_curve_reliability</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">,</span> <span class="n">_peak</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests to check for reliable H/V curve</span>
<span class="sd">    Tests include:</span>
<span class="sd">        1) Peak frequency is greater than 10 / window length (f0 &gt; 10 / Lw)</span>
<span class="sd">            f0 = peak frequency [Hz]</span>
<span class="sd">            Lw = window length [seconds]</span>
<span class="sd">        2) Number of significant cycles (Nc) is greater than 200 (Nc(f0) &gt; 200)</span>
<span class="sd">            Nc = Lw * Nw * f0</span>
<span class="sd">                Lw = window length [sec]</span>
<span class="sd">                Nw = Number of windows used in analysis</span>
<span class="sd">                f0 = peak frequency [Hz]</span>
<span class="sd">        3) StDev of amplitude of H/V curve is less than 2 at all frequencies between 0.5f0 and 2f0</span>
<span class="sd">            (less than 3 if f0 is less than 0.5 Hz)</span>
<span class="sd">            f0 = peak frequency [Hz]</span>
<span class="sd">            StDev is a measure of the variation of all the H/V curves generated for each time window</span>
<span class="sd">                Our main H/V curve is the median of these</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_dict   : dict</span>
<span class="sd">        Dictionary containing all important information generated about HVSR curve</span>
<span class="sd">    _peak       : list of dicts</span>
<span class="sd">        A list of dictionaries, with each dictionary containing information about each peak</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _peak   : same as above, except with information about curve reliability tests added</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">anyKey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#Doesn&#39;t matter which channel we use as key</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">]</span><span class="o">.</span><span class="n">delta</span>
    <span class="n">window_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">]</span><span class="o">.</span><span class="n">len</span> <span class="o">*</span> <span class="n">delta</span><span class="p">)</span> <span class="c1">#Window length in seconds</span>
    <span class="n">window_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="n">peakFreq</span><span class="o">=</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span>
        <span class="n">test1</span> <span class="o">=</span> <span class="n">peakFreq</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">/</span><span class="n">window_len</span>
        <span class="n">test2</span> <span class="o">=</span> <span class="n">window_len</span> <span class="o">*</span> <span class="n">window_num</span> <span class="o">*</span> <span class="n">peakFreq</span> <span class="o">&gt;</span> <span class="mi">200</span>

        <span class="n">halfF0</span> <span class="o">=</span> <span class="n">peakFreq</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">doublef0</span> <span class="o">=</span> <span class="n">peakFreq</span><span class="o">*</span><span class="mi">2</span>
        
        <span class="n">test3</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">failCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">halfF0</span> <span class="ow">and</span> <span class="n">freq</span> <span class="o">&lt;</span><span class="n">doublef0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">peakFreq</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_log_std&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">test3</span><span class="o">=</span><span class="kc">False</span>
                        <span class="n">failCount</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1">#if peak freq is less than 0.5</span>
                    <span class="k">if</span> <span class="n">hvsr_dict</span><span class="p">[</span><span class="s1">&#39;hvsr_log_std&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">test3</span><span class="o">=</span><span class="kc">False</span>
                        <span class="n">failCount</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Window Length Freq.&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test1</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Significant Cycles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test2</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Low Curve StDev. over time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test3</span>
    <span class="k">return</span> <span class="n">_peak</span>

<span class="c1">#Check clarity of peaks</span>
<span class="k">def</span> <span class="nf">__check_clarity</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_peak</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check clarity of peak amplitude(s)</span>

<span class="sd">       Test peaks for satisfying amplitude clarity conditions as outlined by SESAME 2004:</span>
<span class="sd">           - there exist one frequency f-, lying between f0/4 and f0, such that A0 / A(f-) &gt; 2</span>
<span class="sd">           - there exist one frequency f+, lying between f0 and 4*f0, such that A0 / A(f+) &gt; 2</span>
<span class="sd">           - A0 &gt; 2</span>
<span class="sd">        ------------------------</span>
<span class="sd">        Parameters:</span>
<span class="sd">            x               : list-like obj </span>
<span class="sd">                List with x-values (frequency or period values)</span>
<span class="sd">            y               : list-like obj </span>
<span class="sd">                List with hvsr curve values</span>
<span class="sd">            _peak   : list of dicts</span>
<span class="sd">                List with dictionaries for each peak, containing info about that peak</span>
<span class="sd">            do_rank : bool=False</span>
<span class="sd">                Include Rank in output</span>
<span class="sd">        ------------------------</span>
<span class="sd">        Returns:</span>
<span class="sd">            _peak   </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">max_rank</span>

    <span class="c1"># Test each _peak for clarity.</span>
    <span class="k">if</span> <span class="n">do_rank</span><span class="p">:</span>
        <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="c1">#Initialize as False</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Freq. Clarity Below&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>

            <span class="c1"># There exist one frequency f-, lying between f0/4 and f0, such that A0 / A(f-) &gt; 2.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span> <span class="o">&lt;=</span> <span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]))</span> <span class="ow">and</span> \
                    <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">_y</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span> <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Freq. Clarity Below&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
    
    <span class="k">if</span> <span class="n">do_rank</span><span class="p">:</span>
        <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="c1">#Initialize as False</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Freq. Clarity Above&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># There exist one frequency f+, lying between f0 and 4*f0, such that A0 / A(f+) &gt; 2.</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">4.0</span> <span class="o">&gt;=</span> <span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="ow">and</span> \
                    <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">_y</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span> <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Freq. Clarity Above&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
<span class="c1">#        if False in clarityPass:</span>
<span class="c1">#            _peak[_i][&#39;Pass List&#39;][&#39;Peak Freq. Clarity Below&#39;] = False</span>
<span class="c1">#        else:</span>
<span class="c1">#            _peak[_i][&#39;Pass List&#39;][&#39;Peak Freq. Clarity Above&#39;] = True</span>

    <span class="c1">#Amplitude Clarity test</span>
    <span class="c1"># Only peaks with A0 &gt; 2 pass</span>
    <span class="k">if</span> <span class="n">do_rank</span><span class="p">:</span>
        <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_a0</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>

        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_a0</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.2f</span><span class="s1"> &gt; </span><span class="si">%0.1f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">],</span> <span class="n">_a0</span><span class="p">,</span> <span class="n">check_mark</span><span class="p">())</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Amp. Clarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.2f</span><span class="s1"> &gt; </span><span class="si">%0.1f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">],</span> <span class="n">_a0</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Amp. Clarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">_peak</span>

<span class="c1">#Check the stability of the frequency peak</span>
<span class="k">def</span> <span class="nf">__check_freq_stability</span><span class="p">(</span><span class="n">_peak</span><span class="p">,</span> <span class="n">_peakm</span><span class="p">,</span> <span class="n">_peakp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test peaks for satisfying stability conditions </span>
<span class="sd">        Test as outlined by SESAME 2004:</span>
<span class="sd">           - the _peak should appear at the same frequency (within a percentage ± 5%) on the H/V</span>
<span class="sd">             curves corresponding to mean + and – one standard deviation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">max_rank</span>

    <span class="c1">#</span>
    <span class="c1"># check σf and σA</span>
    <span class="c1">#</span>
    <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">#First check below</span>
    <span class="n">_found_m</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="n">_dx</span> <span class="o">=</span> <span class="mf">1000000.</span>
        <span class="n">_found_m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peakm</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">_dx</span><span class="p">:</span>
                <span class="n">_index</span> <span class="o">=</span> <span class="n">_j</span>
                <span class="n">_dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.95</span> <span class="o">&lt;=</span> <span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1"> within ±5</span><span class="si">%s</span><span class="s1"> of </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
                                                                                 <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_found_m</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1"> within ±5</span><span class="si">%s</span><span class="s1"> of </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="c1">##changed i to j</span>
                                                                             <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>

    <span class="c1">#Then Check above</span>
    <span class="n">_found_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="n">_dx</span> <span class="o">=</span> <span class="mf">1000000.</span>
        <span class="n">_found_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peakp</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">_dx</span><span class="p">:</span>
                <span class="n">_index</span> <span class="o">=</span> <span class="n">_j</span>
                <span class="n">_dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.95</span> <span class="o">&lt;=</span> <span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_found_m</span><span class="p">[</span><span class="n">_i</span><span class="p">]:</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1"> within ±5</span><span class="si">%s</span><span class="s1"> of </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="n">check_mark</span><span class="p">())</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Freq. Stability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1"> within ±5</span><span class="si">%s</span><span class="s1"> of </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Freq. Stability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_peakp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1"> within ±5</span><span class="si">%s</span><span class="s1"> of </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span><span class="c1">###changed i to j</span>

    <span class="k">return</span> <span class="n">_peak</span>

<span class="c1">#Check stability</span>
<span class="k">def</span> <span class="nf">__check_stability</span><span class="p">(</span><span class="n">_stdf</span><span class="p">,</span> <span class="n">_peak</span><span class="p">,</span> <span class="n">_hvsr_log_std</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test peaks for satisfying stability conditions as outlined by SESAME 2004</span>
<span class="sd">    This includes:</span>
<span class="sd">       - σf lower than a frequency dependent threshold ε(f)</span>
<span class="sd">       - σA (f0) lower than a frequency dependent threshold θ(f),</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">max_rank</span>

    <span class="n">peakPassList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#</span>
    <span class="c1"># check σf and σA</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">rank</span><span class="p">:</span>
        <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
        <span class="n">_this_peak</span> <span class="o">=</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span>
                                                                            <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.48</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span>
                                                                    <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="mf">0.2</span> <span class="o">&lt;=</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span>
                                                                            <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.40</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span>
                                                                    <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="mf">0.5</span> <span class="o">&lt;=</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.15</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span>
                                                                            <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span> <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="mf">1.0</span> <span class="o">&lt;=</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span>
                                                                            <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span> <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span>
                                                                            <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> * </span><span class="si">%0.3f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_e</span><span class="p">,</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span> <span class="n">check_mark</span><span class="p">())</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (amp. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> &lt; </span><span class="si">%0.2f</span><span class="s1">  </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">_t</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Pass List&#39;</span><span class="p">][</span><span class="s1">&#39;Peak Stability (freq. std)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">_peak</span>

<span class="c1">#Get frequency standard deviation</span>
<span class="k">def</span> <span class="nf">__get_stdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">indexList</span><span class="p">,</span> <span class="n">hvsrPeaks</span><span class="p">):</span>
    <span class="n">stdf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexList</span><span class="p">:</span>
        <span class="n">point</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsrPeaks</span><span class="p">)):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsrPeaks</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">hvsrPeaks</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#Find closest peak in current time to (current) main hvsr peak</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">hvsrPeaks</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">p</span><span class="p">):</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">hvsrPeaks</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">)):</span>
            <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="n">l</span><span class="p">]])</span>
        <span class="n">stdf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">stdf</span>

<span class="c1">#Get or print report</span>
<div class="viewcode-block" id="print_report"><a class="viewcode-back" href="../../hvsr.html#hvsr.sprit.print_report">[docs]</a><span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="n">export</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;print&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a report of the HVSR analysis (not currently implemented)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    export : str</span>
<span class="sd">        Filepath path for export. If not specified, report name is generated automatically and placed in current directory</span>
<span class="sd">    format : {&#39;print&#39;, &#39;docx&#39;, &#39;...&#39;}</span>
<span class="sd">        Format in which to print or export the report</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#print statement</span>

    <span class="k">if</span> <span class="n">export</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1">#code to write to output file</span>
    <span class="k">return</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SPRIT 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hvsr.sprit</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, Riley Balikian.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
    </div>
  </body>
</html>